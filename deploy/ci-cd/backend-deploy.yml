name: Deploy Backend to GKE

on:
  push:
    branches: [main]
    paths:
      - 'services/api/**'
      - 'deploy/ci-cd/backend-deploy.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER }}
  GKE_REGION: ${{ secrets.GKE_REGION }}
  ARTIFACT_REGISTRY: ${{ secrets.ARTIFACT_REGISTRY }}
  IMAGE: devhub-api

jobs:
  build-and-deploy:
    name: Build and Deploy to GKE
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'maven'

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
        service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ secrets.ARTIFACT_REGISTRY }}

    - name: Build with Maven
      working-directory: ./services/api
      run: mvn clean package -DskipTests

    - name: Run tests
      working-directory: ./services/api
      run: mvn test

    - name: Build Docker image
      working-directory: ./services/api
      run: |
        docker build \
          -t ${{ secrets.ARTIFACT_REGISTRY }}/$PROJECT_ID/devhub-repo/$IMAGE:$GITHUB_SHA \
          -t ${{ secrets.ARTIFACT_REGISTRY }}/$PROJECT_ID/devhub-repo/$IMAGE:latest \
          .

    - name: Push to Artifact Registry
      run: |
        docker push ${{ secrets.ARTIFACT_REGISTRY }}/$PROJECT_ID/devhub-repo/$IMAGE:$GITHUB_SHA
        docker push ${{ secrets.ARTIFACT_REGISTRY }}/$PROJECT_ID/devhub-repo/$IMAGE:latest

    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_REGION }}

    - name: Update deployment YAML with image
      working-directory: ./deploy/kubernetes
      run: |
        sed -i "s|PROJECT_ID|$PROJECT_ID|g" deployment.yaml
        sed -i "s|PROJECT_ID|$PROJECT_ID|g" workload-identity.yaml

    - name: Deploy to GKE
      working-directory: ./deploy/kubernetes
      run: |
        kubectl apply -f workload-identity.yaml
        kubectl apply -f deployment.yaml
        kubectl apply -f service.yaml
        kubectl apply -f ingress.yaml

    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/devhub-api --timeout=5m

    - name: Get service info
      run: |
        echo "Deployment status:"
        kubectl get deployments
        echo ""
        echo "Services:"
        kubectl get services
        echo ""
        echo "Ingress:"
        kubectl get ingress
        echo ""
        echo "Pods:"
        kubectl get pods -l app=devhub-api
